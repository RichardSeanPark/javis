# 자비스 AI 프레임워크 아키텍처 분석 및 시각화

## 목차
1. [프레임워크 개요](#1-프레임워크-개요)
2. [아키텍처 구성 요소](#2-아키텍처-구성-요소)
3. [계층별 기능 설명](#3-계층별-기능-설명)
4. [데이터 흐름 분석](#4-데이터-흐름-분석)
5. [핵심 컴포넌트 상세](#5-핵심-컴포넌트-상세)
6. [에이전트 간 상호작용](#6-에이전트-간-상호작용)
7. [구현 가이드](#7-구현-가이드)
8. [주요 처리 시나리오 예시](#8-주요-처리-시나리오-예시)
9. [최적화 및 보안 전략](#9-최적화-및-보안-전략)

## 1. 프레임워크 개요

자비스 AI 프레임워크는 Ubuntu 환경에서 운영되는 다중 에이전트 기반 AI 시스템으로, 사용자의 다양한 입력(텍스트, 음성, 이미지, 동영상)을 처리하고 적절한 에이전트를 통해 다양한 요청에 응답할 수 있도록 설계되었습니다.

### 주요 목표
- 다양한 도메인(코딩, 문서 작성, 문화, 데이터 분석 등)의 질문에 특화된 에이전트 활용
- 다중 에이전트의 효율적 오케스트레이션 구현
- Google Agent Development Kit (ADK)와 Agent2Agent (A2A) 프레임워크 활용
- 유사 기능의 에이전트 모듈화 및 중앙 관리 컴포넌트를 통한 제어

### 핵심 기술 스택
- **Google ADK**: 에이전트 개발 및 실행 환경
- **Google A2A**: 에이전트 간 상호 운용성 프로토콜
- **LLM 모델**: Gemini, Codey 등 다양한 목적별 모델
- **Ubuntu 리눅스**: 기본 운영 환경

![아키텍처 개요](diagrams/new_architecture_diagram_ko.png)

## 2. 아키텍처 구성 요소

자비스 AI 프레임워크는 다계층 에이전트 시스템으로 구성되어 있으며, 각 계층은 특정 역할을 담당합니다.

### 컴포넌트 계층 구조

프레임워크의 주요 구성 요소는 다음과 같은 계층 구조로 조직화됩니다:

![컴포넌트 계층 구조](diagrams/component_hierarchy_diagram_ko.png)

### 프레임워크 레이어 아키텍처

자비스 AI 프레임워크는 다음과 같은 계층 구조로 설계되었습니다:

![레이어 스택 아키텍처](diagrams/layer_stack_diagram_ko.png)

### 주요 컴포넌트
1. **사용자 인터페이스 계층**: 웹 UI, CLI, API 등
2. **입력 처리 계층**: 텍스트, 음성, 이미지 등 다양한 입력 처리
3. **에이전트 라우팅 계층**: 중앙 관리자/디스패처 역할
4. **도메인별 에이전트 계층**: 전문화된 에이전트 모듈
5. **툴 및 컨텍스트 관리 계층**: 에이전트 도구 및 컨텍스트 관리
6. **응답 생성 계층**: 최종 사용자 응답 생성 및 포맷팅

## 3. 계층별 기능 설명

### 사용자 인터페이스 계층
- **웹 UI**: 브라우저 기반 대화형 인터페이스
- **CLI**: 커맨드 라인 인터페이스
- **API**: 외부 시스템과의 통합을 위한 프로그래밍 인터페이스
- **음성 인터페이스**: 음성 기반 상호작용

### 입력 처리 계층
- **텍스트 처리**: 자연어 이해, 의도 분류, 텍스트 분석
- **음성 처리**: STT(Speech-to-Text) 변환
- **이미지 처리**: 비전 분석, OCR, 객체 인식
- **동영상 처리**: 장면 분석, 오디오 추출

### 에이전트 라우팅 계층 (MCP/Dispatcher)
- **중앙 관리자/디스패처**: 입력 분석 결과를 기반으로 처리할 에이전트 또는 에이전트 조합을 결정하고 전체 워크플로우를 조율
- **하이브리드 라우팅 전략**:
  * **ADK 내부 위임 활용**: Google ADK의 계층 구조와 자동 위임(auto delegation) 기능을 통해 내부 에이전트 간의 긴밀한 협업 및 라우팅 수행
  * **규칙 기반 라우팅**: 명확한 조건에 따라 특정 에이전트를 직접 지정
  * **A2A 동적 검색 활용**: 필요한 능력이 내부 에이전트에 없거나 외부/이기종 에이전트 연동이 필요할 경우, Agent Hub의 A2A Discovery 서비스 활용
- **맥락 관리**: 작업 수행에 필요한 컨텍스트와 도구를 적절한 에이전트(ADK 또는 A2A 기반)에 공급
- **에이전트 관리 지원**: 에이전트 허브와 연계하여 에이전트 상태 모니터링 및 관리 지원

### 도메인별 에이전트 계층
- **코어 에이전트**: 기본적인 작업을 처리하는 핵심 에이전트
- **특화 에이전트**: 도메인별 전문 에이전트(코딩, 문서 작성, 지식 QA 등)

### 툴 및 컨텍스트 관리 계층
- **도구 레지스트리**: 에이전트가 사용할 수 있는 외부 도구 관리
- **컨텍스트 관리**: 대화 맥락, 사용자 정보 등 상태 관리
- **외부 API 연동**: 외부 서비스 접근 관리

### 응답 생성 계층
- **결과 통합**: 다중 에이전트 결과 통합
- **포맷팅**: 사용자 인터페이스에 적합한 응답 형식 변환
- **컨텍스트 업데이트**: 상태 및 대화 이력 업데이트

## 4. 데이터 흐름 분석

자비스 AI 프레임워크 내에서 데이터가 어떻게 흐르는지 살펴보겠습니다.

### 기본 데이터 흐름
1. 사용자 입력 → 2. 입력 처리 → 3. 라우팅 → 4. 에이전트 처리 → 5. 도구 실행 → 6. 컨텍스트 업데이트 → 7. 응답 생성 → 8. 사용자 응답

![데이터 흐름 다이어그램](diagrams/data_flow_diagram_ko.png)

### 처리 과정 설명
- **사용자 입력**: 다양한 형태의 입력(텍스트, 음성, 이미지)이 시스템에 전달
- **입력 처리**: 멀티모달 입력을 정규화하고 임베딩 생성
- **라우팅**: 의도 분류 및 적절한 에이전트 선정
- **에이전트 처리**: 선택된 에이전트가 요청 처리 및 도구 호출
- **도구 실행**: 필요한 외부 도구 및 API 호출
- **컨텍스트 업데이트**: 세션 상태 및 대화 맥락 업데이트
- **응답 생성**: 최종 응답 포맷팅 및 멀티모달 출력 생성
- **사용자 응답**: 처리된 응답을 사용자에게 전달

## 5. 핵심 컴포넌트 상세

### 5.1. 입력 파서 (Input Parser)
- 사용자 입력 해석 및 의도 분석
- 텍스트, 음성, 이미지 등 다양한 입력 유형 처리
- 대화 맥락 파악 및 관련 컨텍스트 전달

### 5.2. 디스패처 (MCP 역할의 관리자)
- **역할**: 시스템 내 요청 라우팅 및 오케스트레이션 담당, 입력 파서 결과 기반으로 작업 에이전트 할당
- **라우팅 실행**:
  * **ADK 내부 위임**: `description` 기반 자동 위임 등 ADK 기능을 활용하여 내부 에이전트에게 작업 전달
  * **규칙 기반 직접 호출**: 정의된 규칙에 따라 특정 에이전트 직접 호출
  * **A2A 검색 요청**: 필요시 Agent Hub에 A2A Discovery 요청하여 외부/이기종 에이전트 검색 및 통신 시작
- **오케스트레이션**: 다중 에이전트(ADK/A2A 혼합 가능) 워크플로우 관리, 상태 추적, 결과 취합
- **기타 기능**:
  * 흐름 제어, 에러 핸들링, 로드 밸런싱
  * 공통 툴박스 및 컨텍스트 주입
  * 에이전트 인증/인가 (A2A 프로토콜 연계 가능)
- **구현**: Google ADK 프레임워크를 기반으로 구현 (예: 최상위 LlmAgent)

### 5.3. 에이전트 허브 (Agent Hub)
- **역할**: 에이전트 레지스트리 및 관리, A2A Discovery 서비스 제공
- **기능**:
  * 에이전트 모듈 초기화 및 등록 (ADK 에이전트, 외부 A2A 에이전트 등)
  * 에이전트 메타데이터(Agent Card 포함) 관리
  * **A2A Discovery 서비스**: Dispatcher 또는 다른 에이전트의 요청에 따라 Agent Card 기반으로 능력 검색 및 해당 에이전트 정보 반환
  * 에이전트 상태, 성능, 리소스 사용량 모니터링

### 5.4. 툴 레지스트리와 컨텍스트 관리
- **툴 레지스트리**:
  * **역할**: 에이전트가 사용할 외부 API, 함수, 리소스 관리
  * **ADK 활용**: Python 함수를 툴로 정의, Docstring으로 사용법 기술하여 LLM 자동 호출 지원
  * 툴별 사용 권한 지정
  * Dispatcher가 에이전트에게 허용된 툴 목록 전달/주입
- **컨텍스트 관리**:
  * **역할**: 요청 관련 추가 컨텍스트(배경지식, 이전 대화, 유저 프로필 등)를 해당 에이전트에게 자동 전달
  * **구현**: 세션 메모리, 벡터 DB 활용
  * A2A 메시지의 콘텐츠 타입 파트(parts) 활용하여 멀티모달 컨텍스트 전달
- **장점**: 시스템 지능 및 사용자 경험 향상, 에이전트 책임 분리 명확화

## 6. 에이전트 간 상호작용

![에이전트 상호작용 다이어그램](diagrams/agent_interaction_diagram_ko.png)

에이전트 간 상호작용은 자비스 AI 프레임워크의 핵심 기능 중 하나입니다. 에이전트들은 다양한 방식으로 협력하여 복잡한 작업을 처리합니다.

* **협업 패턴:**
- **순차적 협업**: 한 에이전트의 출력이 다른 에이전트의 입력으로 전달
- **병렬 협업**: 여러 에이전트가 동시에 작업 수행 후 결과 통합
- **위임 기반**: 상위 에이전트가 하위 에이전트에게 작업 위임

### 통신 메커니즘
- **내부 통신**: ADK 함수 호출, 공유 메모리
- **외부 통신**: A2A 프로토콜 기반 메시지 교환
- **컨텍스트 공유**: 에이전트 간 상태 및 중간 결과물 공유

## 7. 구현 가이드

### Google ADK의 역할 및 활용

Google ADK(Agent Development Kit)는 자비스 프레임워크의 중심 축을 이루는 오픈소스 에이전트 개발 프레임워크입니다.

* **에이전트 구현 간소화:**
  * Python toolkit으로 핵심 로직(프롬프트, 모델, 툴) 작성이 간편합니다.
  * `Agent`/`LlmAgent` 클래스로 에이전트를 정의하면 ADK 런타임이 나머지 부분을 처리합니다.

```python
# 예시: ADK를 활용한 에이전트 정의
from google.ai.generativelanguage import Tool
from google.adk import Agent, AgentResponse, LlmConfig

class WeatherAgent(Agent):
    def __init__(self):
        super().__init__(
            name="WeatherAgent",
            description="날씨 정보 제공 및 관련 질문 응답",
            llm_config=LlmConfig(model="gemini-2.0-flash-exp"),
            tools=[get_weather]
        )
    
    # ADK 프레임워크가 처리

* **다중 에이전트/서브에이전트 구조 지원:**
  * 계층적 구조 및 에이전트 간 위임 메커니즘을 제공합니다.
  * 설명 기반(description-driven) 라우팅 및 자동 위임(auto delegation) 기능을 활용할 수 있습니다.

* **툴 통합과 상태 관리:**
  * 에이전트 내 툴 호출 오케스트레이션 및 세션 상태 저장 기능이 내장되어 있습니다.
  * Docstring과 instruction 중심으로 툴 사용 로직을 구현할 수 있습니다.

* **멀티모달 및 스트리밍 지원:**
  * 양방향 스트리밍으로 오디오/비디오 등 실시간 인터랙션을 구현할 수 있습니다.

* **배포 및 인터페이스:**
  * 다양한 인터페이스(CLI, 웹, API) 지원 및 클라우드 배포가 용이합니다.
  * 개발-배포 간 에이전트 로직의 일관성을 유지할 수 있습니다.

* **평가 및 디버깅:**
  * 시나리오 테스트, 품질 평가를 위한 도구를 제공합니다.
  * 로깅/디버깅 기능을 활용하여 에이전트의 동작을 모니터링할 수 있습니다.

### Google A2A 활용 방법

Google A2A(Agent-to-Agent)는 에이전트 상호 운용성(interoperability)을 위한 개방형 프로토콜입니다.

![A2A 기반 에이전트 통합](diagrams/a2a_integration_diagram.png)

* **이기종 에이전트 통신 표준화:**
  * 서로 다른 환경/언어로 구현된 에이전트 간 공통 규약을 제공합니다.
  * 메시지, 작업 정의, 상태 업데이트, 인증 방식을 표준화하여 플러그 앤 플레이 통합을 지원합니다.
  * 산업 표준으로 발전 중이며, 시스템 확장성을 확보할 수 있습니다.

* **에이전트 능력 광고 및 검색:**
  * **Agent Card:** JSON으로 Capabilities를 광고하고 발견(discovery)할 수 있습니다.
  * 동적 에이전트 풀 확장이 가능합니다.

* **보안 및 인증:**
  * 기관 간 인증, 권한 부여 등 보안 기능이 내장되어 있습니다.
  * JWT/OAuth 유사 방식으로 신원 확인 및 권한 범위 내 요청 처리가 가능합니다.
  * 메시지 필터링/암호화 옵션을 제공합니다.
  * 엔터프라이즈 환경을 위한 보안 기능 강화:
    * 안전한 에이전트 간 통신과 데이터 교환 보장
    * 권한 기반 에이전트 접근 제어
    * 중요 정보에 대한 암호화 및 보호 메커니즘
  * 푸시 알림과 같은 실시간 통신 보안 지원

* **복잡한 워크플로우의 에이전트 협력:**
  * 멀티에이전트 워크플로우(순차/병렬)를 지원합니다.
  * 상태 및 중간 산출물(artifact) 공유 메커니즘을 제공합니다.
  * 표준화된 작업 객체(task object)로 추적/관리가 용이합니다.

* **지원 프레임워크 및 통합:**
  * Google ADK, CrewAI, LangGraph, Genkit 등 다양한 에이전트 개발 도구와 통합 가능합니다.
  * 웹 앱, CLI 인터페이스, 서버 환경 등 다양한 호스트 환경에서 구현할 수 있습니다.
  * A2A와 MCP(Model Context Protocol)의 조합으로 더 강력한 에이전트 시스템 구축이 가능합니다.

ADK가 에이전트 개발 도구라면, A2A는 에이전트 간 대화 언어를 제공합니다. 본 아키텍처에서는 ADK를 내부 에이전트 개발 및 긴밀한 오케스트레이션의 기반으로 활용하고, A2A는 이기종 에이전트와의 상호 운용성 확보 및 동적 능력 검색이 필요할 때 ADK를 보완하는 역할을 수행하여 시너지를 창출합니다.

### 배포 및 확장 전략
- 로컬 개발: CLI 인터페이스 활용
- 웹 서비스: ADK 웹 UI 또는 커스텀 프론트엔드
- API 서버: RESTful API 제공
- 컨테이너화: Docker 및 Kubernetes 활용 스케일 아웃

## 8. 주요 처리 시나리오 예시

자비스 AI 프레임워크가 실제로 어떻게 작동하는지 시나리오 예시를 통해 살펴보겠습니다.

![시나리오 흐름도](diagrams/scenario_flow_diagram.png)

### 8.1. 코딩 질문 처리 흐름

**사용자 요청:** "다음 파이썬 코드를 개선해서 실행 속도를 높여줄 수 있어? 코드: ```python\n...```"

1. **입력 수신 및 전처리:**
   * 웹 UI에서 텍스트와 코드 블록 수신
   * 입력 파서가 코딩 관련 키워드를 탐지하고 코드 블록 추출
   * 메타데이터 태깅: "도메인=코딩", "요청유형=코드 개선"
   * 관련 대화 맥락 파악

2. **디스패처 라우팅 결정:**
   * "도메인=코딩" 신호를 기반으로 `CodingAgent` 선택
   * `CodingAgent`의 Agent Card 확인 (파이썬 코드 최적화 능력 검증)
   * 캐시 조회 (해당 없음)

3. **에이전트 실행 및 작업 처리:**
   * 디스패처가 `CodingAgent`에 작업 할당 (내부 A2A 메시지 또는 ADK 방식)
   * `CodingAgent` (ADK 구현):
     * `optimize_code(code, goal)` 툴 함수 보유 및 LLM 프롬프트 지시
     * 코드 특화 LLM (Codex, Codey) 호출
     * 필요시 코드 실행/프로파일링 툴 활용 (ADK 툴)

4. **응답 생성:**
   * `CodingAgent` LLM이 최적화된 코드와 개선 설명 생성
   * 결과를 Artifact 객체로 래핑하여 반환 (ADK 방식)
   * A2A 사용 시 표준 출력 형식으로 전달, Task 완료 신호

5. **후처리 및 포맷팅:**
   * 디스패처가 결과 수신 후 사용자 친화적 형식으로 다듬기 (마크다운, 하이라이트)
   * 필요시 ParaphrasingAgent로 쉬운 설명 추가 (작은 LLM 활용)

6. **응답 반환:**
   * 정리된 최종 답변을 웹 UI로 출력
   * Q&A 내용을 세션 컨텍스트 저장소에 기록

### 8.2. 다른 시나리오에의 적용

* **문화적 질의:** 지식 QA 에이전트 호출, 필요시 웹 검색 툴 사용
* **데이터 분석:** DataAnalyzer (데이터 처리) + Visualization (그래프 생성) + ReportGenerator (요약) 에이전트 협업
* **이미지 요청:** VisionAgent (이미지 분석) -> 결과 텍스트 설명 -> 추가 질문 시 QA 에이전트로 전환 (컨텍스트 유지)

어떤 종류의 요청에도 시스템이 유연하게 적응하여 최적의 에이전트 파이프라인을 선택하고 응답을 제공하는 것이 자비스 프레임워크의 핵심 목표입니다.

## 9. 최적화 및 보안 전략

### 성능 최적화
- **경량 모델 활용**: 간단 작업은 소형 모델/규칙 기반 로직 사용
- **병렬 처리**: 독립 작업 동시 실행
- **캐싱**: 유사 질문 응답 및 중간 결과 재활용
- **컨텍스트 최소화**: 필요 정보만 에이전트에 전달
- **자원 스케줄링**: GPU/CPU 효율적 할당

### 보안 전략

![보안 전략 다이어그램](diagrams/security_strategy_diagram.png)

- **권한 분리 및 샌드박싱:**
  - 에이전트별로 행동과 접근 권한을 엄격히 제한합니다.
  - 코드 실행은 안전한 샌드박스 환경(Docker, seccomp)에서만 수행합니다.
  - 파일 시스템/네트워크 접근을 엄격히 통제합니다.
  - 데이터베이스 접근 권한을 최소화합니다.
  - 각 에이전트를 격리된 환경에서 실행하여 상호 간섭을 방지합니다.

- **프롬프트 안전장치 및 검열:**
  - 시스템 레벨의 Content Filter를 적용하여 부적절한 출력을 차단합니다.
  - 에이전트 지시문에 역할(role) 제한을 명시하여 악성 지시를 방지합니다.
  - 정책 프롬프트와 후단 검열기를 조합하여 이중 방어벽을 구축합니다.
  - 민감한 정보 필터링과 개인정보 보호 메커니즘을 적용합니다.

- **A2A 인증 및 암호화:**
  - A2A 기본 인증/인가 메커니즘을 적용하여 에이전트 간 통신을 보호합니다.
  - JWT/OAuth 유사 방식으로 에이전트 신원을 확인합니다.
  - 권한 범위 내에서만 요청이 처리되도록 제한합니다.
  - 필요에 따라 메시지 필터링 및 암호화 옵션을 적용합니다.

- **모니터링 및 감사:**
  - 모든 에이전트 작업과 상호작용을 지속적으로 로깅하고 감사합니다.
  - 비정상 행동 감지 시스템을 구축하여 이상 활동을 탐지합니다.
  - Fail-safe 메커니즘을 통해 비정상 동작 발견 시 안전하게 중단합니다.
  - 정기적인 보안 검사와 취약점 분석을 수행합니다.

이러한 보안 전략을 통해 에이전트 시스템의 안전성과 신뢰성을 확보하고, 악의적인 사용이나 오용으로부터 시스템을 보호할 수 있습니다.

---

본 문서는 자비스 AI 프레임워크의 아키텍처를 시각화하고 상세하게 분석한 내용입니다. 다이어그램과 함께 각 계층별 기능, 데이터 흐름, 컴포넌트 상세 정보를 제공하여 프레임워크의 이해와 구현에 도움이 되고자 합니다. 